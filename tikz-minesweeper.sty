\ProvidesPackage{tikz-minesweeper}
[2022/01/07, v0.1.0]
\RequirePackage{tikz}
\RequirePackage{expl3}

% Color tables
\definecolor{color0}{RGB}{192,192,192}
\definecolor{color1}{RGB}{0,0,255}
\definecolor{color2}{RGB}{0,128,0}
\definecolor{color3}{RGB}{255,0,0}
\definecolor{color4}{RGB}{0,0,128}
\definecolor{color5}{RGB}{122,43,26}
\definecolor{color6}{RGB}{0,128,128}
\definecolor{color7}{RGB}{0,0,0}
\definecolor{color8}{RGB}{128,128,128}
\definecolor{cborder}{RGB}{160,160,160}
\definecolor{clight}{RGB}{255,255,255}

%%%%%%%%%
% CELLS %
%%%%%%%%%
% \flag : draw a flag in cell
% \mine : draw a mine in cell
% \cellup : draw an up cell
% \celldown : draw a down cell
% \cellnum{number} : fill cell with number
% \cell{x}{y}{content} : draw a cell at (x,y) and put content in it. If the content is a number then the cell is down. otherwise the cell is up. Let content=f to put a flag.
% \row{x}{content} : draw the x-th row with content. For example, \row{0}{1{20}0fA}

\ExplSyntaxOn
    \cs_set:Nn \element_flag: {
        \fill[color7] (5pt, -13pt) rectangle (12pt, -12pt); % lower base
        \fill[color7] (6.5pt, -13pt) rectangle (10.5pt, -11pt); % upper base
        \fill[color7] (8.5pt, -13pt) rectangle (9.5pt, -4pt); % pole
        \fill[color3] (8.5pt, -4.5pt) -- (4pt, -6.5pt) -- (8.5pt, -8.5pt) -- cycle; % red flag
    }

    \cs_set:Nn \element_mine: {
        \int_step_inline:nnnn {0} {45} {135} {
            \fill[color7, xshift=8.5pt, yshift=-8.5pt, rotate=##1] (-6.5pt, 0.4pt) -- (0, 1.5pt) -- (6.5pt, 0.4pt) -- (6.5pt, -0.4pt) -- (0, -1.5pt) -- (-6.5pt, -0.4pt) -- cycle; % spikes
        }
        \shade[ball~color=color7] (8.5pt,-8.5pt) circle (4.5pt); % body
    }

    \cs_set:Nn \element_cellup: {
        \fill[color0] (0, 0) rectangle (16pt, -16pt); % background
        \fill[clight] (0, 0) -- (16pt, 0) -- (14pt, -2pt) -- (2pt, -2pt) -- (2pt, -14pt) -- (0, -16pt) -- cycle; % highlight
        \fill[color8] (16pt, -16pt) -- (0pt, -16pt) -- (2pt, -14pt) -- (14pt, -14pt) -- (14pt, -2pt) -- (16pt, 0) -- cycle; % shade
    }

    \cs_set:Nn \element_celldown: {
        \fill[color8] (0, 0) -- (16pt, 0) -- (16pt, -1pt) -- (1pt, -1pt) -- (1pt, -16pt) -- (0, -16pt) -- cycle; % border
        \fill[color0] (1pt, -16pt) rectangle (16pt, -1pt); % background
    }

    \cs_set:Npn \element_cellnum:n #1 {
        \tl_set:Nn \l_tmpa_tl {color}
        \tl_put_right:Nn \l_tmpa_tl {#1}
        \node[text~centered, text=\l_tmpa_tl] at (8.5pt, -8.5pt) {\textbf{#1}};
    }

    \cs_set:Npn \element_cell:nnn #1#2#3 {
        \sffamily
        \tl_set:Nn \l_tmpa_tl {012345678}
        \begin{scope}[xshift=#3*16pt,yshift=-#2*16pt]
            \tl_if_single:nTF {#1} {
                % single token
                \tl_if_in:NnTF \l_tmpa_tl {#1} {
                    % number
                    \element_celldown:
                    \element_cellnum:n {#1}
                } {
                    % otherwise
                    \tl_case:NnF #1 {
                        f {
                            % flag
                            \element_cellup:
                            \element_flag:
                        }
                        m {
                            % mine
                            \element_celldown:
                            \element_mine:
                        }
                    } {
                        % otherwise
                        \element_cellup:
                        \node[text~centered, text={color7}] at (8pt, -8pt) {\textbf{#1}}; % normal label
                    }
                }
            } {
                % otherwise
                \element_cellup:
                \node[text~centered, text={color7}] at (8pt, -8pt) {\textbf{\tiny #1}}; % tiny label
            }
        \end{scope}
    }

    \cs_set:Npn \element_row:nn #1#2 {
        \tl_set:Nn \l_tmpa_tl {#2}
        \int_zero:N \l_tmpa_int
        \tl_map_inline:Nn \l_tmpa_tl {
            \element_cell:nnn {##1}{#1}{\l_tmpa_int}
            \int_incr:N \l_tmpa_int
        }
    }

    \newcommand{\flag}{\element_flag:}
    \newcommand{\mine}{\element_mine:}
    \newcommand{\cellup}{\element_cellup:}
    \newcommand{\celldown}{\element_celldown:}
    \newcommand{\cellnum}{\element_cellnum:n}
    \newcommand{\cell}[3]{\element_cell:nnn {#1}{#2}{#3}}
    \newcommand{\row}[2]{\element_row:nn {#1}{#2}}
\ExplSyntaxOff

%%%%%%%%%%%
% BORDERS %
%%%%%%%%%%%
\newcommand{\tborder}[1]{
    \fill[clight] (0, 9pt) rectangle (#1*16pt, 12pt);
    \fill[color0] (0, 3pt) rectangle (#1*16pt, 9pt);
    \fill[cborder] (0, 0) rectangle (#1*16pt, 3pt);
    \draw[cborder,ultra thin] (0, 12pt) -- (#1*16pt, 12pt);
}
\newcommand{\lborder}[1]{
    \fill[clight] (-9pt, 0) rectangle (-12pt, -#1*16pt);
    \fill[color0] (-3pt, 0) rectangle (-9pt, -#1*16pt);
    \fill[cborder] (0, 0) rectangle (-3pt, -#1*16pt);
    \draw[cborder,ultra thin] (-12pt,0) -- (-12pt, -#1*16pt);
}
\newcommand{\bborder}[1]{
    \fill[cborder] (0, -9pt) rectangle (#1*16pt, -12pt);
    \fill[color0] (0, -3pt) rectangle (#1*16pt, -9pt);
    \fill[clight] (0, 0) rectangle (#1*16pt, -3pt);
}
\newcommand{\rborder}[1]{
    \fill[cborder] (9pt, 0) rectangle (12pt, -#1*16pt);
    \fill[color0] (3pt, 0) rectangle (9pt, -#1*16pt);
    \fill[clight] (0, 0) rectangle (3pt, -#1*16pt);
}
\newcommand{\tlborder}{
    \fill[clight] (0, 0) rectangle (-12pt, 12pt);
    \fill[color0] (0, 0) rectangle (-9pt, 9pt);
    \fill[cborder] (0, 0) rectangle (-3pt, 3pt);
    \draw[cborder,ultra thin] (-12pt, 0) -- (-12pt, 12pt) -- (0, 12pt);
}
\newcommand{\brborder}{
    \fill[cborder] (0, 0) rectangle (12pt, -12pt);
    \fill[color0] (0, 0) rectangle (9pt, -9pt);
    \fill[clight] (0, 0) rectangle (3pt, -3pt);
}
\newcommand{\trborder}{
    \fill[color0] (0, 0) rectangle (9pt, 9pt);
    \fill[cborder] (0, 0) -- (3pt, 3pt) -- (0, 3pt) -- cycle;
    \fill[cborder] (9pt, 9pt) -- (12pt, 12pt) -- (12pt, 0) -- (9pt, 0) -- cycle;
    \fill[clight] (0, 0) -- (3pt, 3pt) -- (3pt, 0) -- cycle;
    \fill[clight] (9pt, 9pt) -- (12pt, 12pt) -- (0, 12pt) -- (0, 9pt) -- cycle;
    \draw[cborder,ultra thin] (12pt, 12pt) -- (0, 12pt);
}
\newcommand{\blborder}{
    \fill[color0] (0, 0) rectangle (-9pt, -9pt);
    \fill[clight] (0, 0) -- (-3pt, -3pt) -- (0, -3pt) -- cycle;
    \fill[clight] (-9pt, -9pt) -- (-12pt, -12pt) -- (-12pt, 0) -- (-9pt, 0) -- cycle;
    \fill[cborder] (0, 0) -- (-3pt, -3pt) -- (-3pt, 0) -- cycle;
    \fill[cborder] (-9pt, -9pt) -- (-12pt, -12pt) -- (0, -12pt) -- (0, -9pt) -- cycle;
    \draw[cborder,ultra thin] (-12pt, -12pt) -- (-12pt, 0);
}

\newcommand{\board}[2]{
    \begin{scope}[shift={(0, 0)}]\tlborder\tborder{#2}\lborder{#1}\end{scope}
    \begin{scope}[shift={(#2*16pt, 0)}]\trborder\rborder{#1}\end{scope}
    \begin{scope}[shift={(0, -#1*16pt)}]\blborder\bborder{#2}\end{scope}
    \begin{scope}[shift={(#2*16pt, -#1*16pt)}]\brborder\end{scope}
}
\newcommand{\tboard}[2]{
    \begin{scope}[shift={(0, 0)}]\tlborder\tborder{#2}\lborder{#1}\end{scope}
    \begin{scope}[shift={(#2*16pt, 0)}]\trborder\rborder{#1}\end{scope}
}
\newcommand{\lboard}[2]{
    \begin{scope}[shift={(0, 0)}]\tlborder\tborder{#2}\lborder{#1}\end{scope}
    \begin{scope}[shift={(0, -#1*16pt)}]\blborder\bborder{#2}\end{scope}
}
\newcommand{\tlboard}[2]{
    \begin{scope}[shift={(0, 0)}]\tlborder\tborder{#2}\lborder{#1}\end{scope}
}
